@model Web_Do_An_Nhanh.Models.HoaDon
@using System.Linq

@{
    ViewBag.Title = "Chi tiết hóa đơn #" + Model.MaHD;
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";

    decimal tamTinh = 0m;
    if (Model.ChiTietHoaDons != null && Model.ChiTietHoaDons.Any())
    {
        foreach (var ct in Model.ChiTietHoaDons)
        {
            tamTinh += ct.DonGia * ct.SoLuong;
        }
    }

    decimal tongDb = Model.TongTien ?? 0m;

    decimal giam = 0m;
    if (Model.KhuyenMai != null && Model.KhuyenMai.PhanTramGiam.HasValue)
    {
        decimal pt = Convert.ToDecimal(Model.KhuyenMai.PhanTramGiam.Value); // 10 = 10%
        giam = Math.Round(tamTinh * pt / 100m, 0);
    }


    bool coShip = Model.PhiShip ?? false;
    decimal phiShipTien = coShip ? 10000m : 0m;
    string phiShipText = coShip ? "Giao hàng (có ship)" : "Không ship";

    string tenTT = Model.TinhTrang != null ? Model.TinhTrang.TenTT : "";
    string statusClass;
    switch (tenTT)
    {
        case "Đã hủy":
            statusClass = "badge bg-danger text-light text-nowrap";
            break;
        case "Đặt thành công":
            statusClass = "badge bg-primary text-light text-nowrap";
            break;
        case "Chờ xác nhận":
            statusClass = "badge bg-warning text-dark text-nowrap";
            break;
        case "Đang vận chuyển":
            statusClass = "badge bg-secondary text-light text-nowrap";
            break;
        case "Đang làm món":
            statusClass = "badge bg-info text-dark text-nowrap";
            break;
        case "Hoàn thành chế biến":
            statusClass = "badge bg-success text-light text-nowrap";
            break;
        case "Đã giao":
            statusClass = "badge bg-success text-light text-nowrap";
            break;
        default:
            statusClass = "badge bg-light text-dark";
            break;
    }
}

<div class="container-fluid py-3">
    <div class="d-flex align-items-center mb-3">
        <div style="width:42px;height:42px;border-radius:50%;display:flex;
             align-items:center;justify-content:center;background:#eff6ff;
             color:#2563eb;font-size:1.3rem;margin-right:.75rem;">
            <i class="fas fa-file-invoice"></i>
        </div>
        <h3 class="fw-bold mb-0" style="color:#2563eb;">
            Chi tiết hóa đơn #@Model.MaHD
        </h3>
    </div>

    <div class="row">
        <div class="col-lg-7 mb-3">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h5 class="fw-bold mb-3">Sản phẩm trong đơn</h5>

                    @if (Model.ChiTietHoaDons == null || !Model.ChiTietHoaDons.Any())
                    {
                        <div class="py-4 text-center text-muted">
                            Hóa đơn chưa có sản phẩm nào.
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-sm align-middle mb-0">
                                <thead class="table-warning">
                                    <tr>
                                        <th style="width:50px;">#</th>
                                        <th>Sản phẩm</th>
                                        <th style="width:80px;" class="text-center">SL</th>
                                        <th style="width:140px;" class="text-end">Đơn giá</th>
                                        <th style="width:160px;" class="text-end">Thành tiền</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @{
                                        int stt = 1;
                                        foreach (var ct in Model.ChiTietHoaDons)
                                        {
                                            var tenSp = ct.SanPham != null ? ct.SanPham.TenSP : ("Mã SP: " + ct.MaSP);
                                            decimal thanhTien = ct.DonGia * ct.SoLuong;
                                            <tr>
                                                <td>@stt</td>
                                                <td>@tenSp</td>
                                                <td class="text-center">@ct.SoLuong</td>
                                                <td class="text-end">@ct.DonGia.ToString("N0") đ</td>
                                                <td class="text-end">@thanhTien.ToString("N0") đ</td>
                                            </tr>
                                            stt++;
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-5 mb-3">
            <div class="card shadow-sm border-0 mb-3">
                <div class="card-body">
                    <h5 class="fw-bold mb-3">Thông tin hóa đơn</h5>

                    <dl class="row mb-0">
                        <dt class="col-sm-4">Mã hóa đơn</dt>
                        <dd class="col-sm-8">#@Model.MaHD</dd>

                        <dt class="col-sm-4">Khách hàng</dt>
                        <dd class="col-sm-8">
                            @(Model.KhachHang != null ? Model.KhachHang.TenKH : "(Khách lẻ)")
                        </dd>

                        <dt class="col-sm-4">Nhân viên</dt>
                        <dd class="col-sm-8">
                            @(Model.NhanVien != null ? Model.NhanVien.TenNV : "(Không rõ)")
                        </dd>

                        <dt class="col-sm-4">Ngày lập</dt>
                        <dd class="col-sm-8">
                            @(Model.NgayLap.HasValue
                                ? Model.NgayLap.Value.ToString("dd/MM/yyyy HH:mm")
                                : "(Chưa có)")
                        </dd>

                        <dt class="col-sm-4">Trạng thái</dt>
                        <dd class="col-sm-8">
                            <span class="@statusClass">@(!string.IsNullOrEmpty(tenTT) ? tenTT : "Không rõ")</span>
                        </dd>

                        <dt class="col-sm-4">Khuyến mãi</dt>
                        <dd class="col-sm-8">
                            @if (Model.KhuyenMai != null)
                            {
                                @Model.KhuyenMai.TenKM
                            }
                            else
                            {
                                <span class="text-muted">Không áp dụng</span>
                            }
                        </dd>

                        <dt class="col-sm-4">Địa chỉ</dt>
                        <dd class="col-sm-8">
                            @if (!string.IsNullOrWhiteSpace(Model.DiaChi))
                            {
                                @Model.DiaChi
                            }
                            else
                            {
                                <span class="text-muted">Không có</span>
                            }
                        </dd>
                    </dl>
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h5 class="fw-bold mb-3">Tổng kết thanh toán</h5>

                    <div class="d-flex justify-content-between mb-1">
                        <span>Tạm tính</span>
                        <span>@tamTinh.ToString("N0") đ</span>
                    </div>

                    <div class="d-flex justify-content-between mb-1">
                        <span>Khuyến mãi</span>
                        <span class="text-danger">
                            -@giam.ToString("N0") đ
                        </span>
                    </div>

                    <div class="text-muted mb-2" style="font-size:.85rem;">
                        @if (Model.KhuyenMai != null)
                        {
                            <span>
                                (@Model.KhuyenMai.TenKM)
                            </span>
                        }
                        else
                        {
                            <span>Không áp dụng khuyến mãi</span>
                        }
                    </div>

                    <div class="d-flex justify-content-between mb-1">
                        <span>Phí ship</span>
                        <span>
                            @phiShipTien.ToString("N0") đ
                            @*<span class="text-muted" style="font-size:.85rem;">
                                    (@phiShipText)
                                </span>*@
                        </span>
                    </div>

                    <hr class="my-2" />

                    <div class="d-flex justify-content-between align-items-baseline mb-1">
                        <span class="fw-bold">Khách phải trả</span>
                        <span class="fw-bold text-danger" style="font-size:1.1rem;">
                            @tongDb.ToString("N0") đ
                        </span>
                    </div>

                    @*<div class="text-muted" style="font-size:.8rem;">
                            * Giá trị lưu trong DB: @tongDb.ToString("N0") đ
                        </div>*@
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        @Html.ActionLink("Quay lại danh sách", "Index", null,
            new { @class = "btn btn-secondary me-2" })
        @Html.ActionLink("Sửa hóa đơn", "Edit", new { id = Model.MaHD },
            new { @class = "btn btn-primary" })
    </div>
</div>
